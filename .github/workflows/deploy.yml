name: Build and Deploy AgentGateway to GKE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_IMAGE: docker.io/tribehealth/agentgateway
  IMAGE_TAG: "01282026"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prep Runner
      uses: ./.github/actions/prep-runner

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '23'
        cache: 'npm'
        cache-dependency-path: ui/package-lock.json

    - name: Build UI
      run: |
        cd ui
        npm install
        npm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Clear corrupted Docker Buildx cache
      run: |
        # Clear the corrupted buildx cache entirely
        docker buildx prune --all --force || true
        echo "Cleared buildx cache to avoid corruption issues"

    - name: Create clean build environment
      run: |
        # Use original Dockerfile but ensure we get a clean build
        # The cache corruption should be resolved by the buildx prune above
        echo "Using original Dockerfile with clean cache environment"

    - name: Build and push multi-arch image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY_IMAGE }}:${{ env.IMAGE_TAG }}
          ${{ env.REGISTRY_IMAGE }}:latest
        build-args: |
          VERSION=${{ env.IMAGE_TAG }}
          GIT_REVISION=${{ github.sha }}
        # Use fresh cache with new key to avoid corruption
        cache-from: type=registry,ref=${{ env.REGISTRY_IMAGE }}:buildcache-clean-${{ github.run_number }}
        cache-to: type=registry,ref=${{ env.REGISTRY_IMAGE }}:buildcache-clean-${{ github.run_number }},mode=max
        pull: true

    - name: Install cosign
      uses: sigstore/cosign-installer@v3.9.2

    - name: Sign the container image
      run: cosign sign --yes ${{ env.REGISTRY_IMAGE }}:${{ env.IMAGE_TAG }}

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > ${HOME}/.kube/config
        kubectl config current-context

    - name: Deploy to Kubernetes
      run: |
        echo "ğŸš€ Deploying AgentGateway to Kubernetes..."

        # Apply all Kubernetes resources
        echo "ğŸ“¦ Creating namespace..."
        kubectl apply -f k8s/namespace.yaml

        echo "âš™ï¸  Applying configuration..."
        kubectl apply -f k8s/configmap.yaml

        echo "ğŸš€ Deploying application..."
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml

        echo "ğŸ” Setting up SSL and ingress..."
        kubectl apply -f k8s/cluster-issuer.yaml
        kubectl apply -f k8s/ingress.yaml

        echo "âœ… All resources applied successfully!"

    - name: Wait for deployment
      run: |
        echo "â³ Waiting for deployment to be ready..."
        kubectl rollout status deployment/agentgateway -n agentgateway --timeout=300s

    - name: Verify deployment
      run: |
        echo "ğŸ” Checking deployment status..."
        kubectl get pods -n agentgateway -l app=agentgateway

        echo "ğŸŒ Checking service status..."
        kubectl get svc -n agentgateway

        echo "ğŸ”— Checking ingress status..."
        kubectl get ingress -n agentgateway

        echo "ğŸ”’ Checking certificate status..."
        kubectl get certificate -n agentgateway || echo "Certificate may still be provisioning"

    - name: Health check
      run: |
        echo "ğŸ©º Performing health checks..."

        # Wait for pods to be fully ready
        sleep 30

        # Test via port-forward first
        echo "Testing via port-forward..."
        kubectl port-forward svc/agentgateway-service 8080:80 -n agentgateway &
        PORT_FORWARD_PID=$!
        sleep 5

        if curl -f http://localhost:8080/health; then
          echo "âœ… Internal health check passed"
        else
          echo "âŒ Internal health check failed"
        fi

        kill $PORT_FORWARD_PID || true
        sleep 2

        # Test external endpoint (may fail initially while cert is provisioning)
        echo "Testing external endpoint..."
        if curl -f -k https://agentgateway.prometheusags.ai/health; then
          echo "âœ… External health check passed"
        else
          echo "âš ï¸  External health check failed (may be expected during initial setup)"
        fi

    - name: Deployment summary
      run: |
        echo "ğŸ‰ Deployment Summary"
        echo "==================="
        echo "âœ… Built from source: ${{ github.sha }}"
        echo "ğŸ³ Docker image: ${{ env.REGISTRY_IMAGE }}:${{ env.IMAGE_TAG }}"
        echo "ğŸŒ Service URL: https://agentgateway.prometheusags.ai"
        echo "ğŸ”§ Namespace: agentgateway"
        echo ""
        echo "ğŸ“‹ Useful commands:"
        echo "  View logs: kubectl logs -f deployment/agentgateway -n agentgateway"
        echo "  Check pods: kubectl get pods -n agentgateway"
        echo "  Check ingress: kubectl describe ingress agentgateway-ingress -n agentgateway"
        echo "  Check cert: kubectl describe certificate agentgateway-tls -n agentgateway"