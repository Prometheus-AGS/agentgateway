name: Build and Deploy AgentGateway to GKE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_IMAGE: docker.io/tribehealth/agentgateway

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate image tag
      id: image_tag
      run: |
        # Generate timestamp in MMDDYY-HHMM format (UTC)
        IMAGE_TAG=$(date -u +'%m%d%y-%H%M')
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "Generated image tag: ${IMAGE_TAG}"

    - name: Prep Runner
      uses: ./.github/actions/prep-runner

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '23'
        cache: 'npm'
        cache-dependency-path: ui/package-lock.json

    - name: Build UI
      run: |
        cd ui
        npm install
        npm run build

    - name: Set up Docker Buildx (Research-Based Solution)
      uses: docker/setup-buildx-action@v3
      with:
        # Create fresh builder with unique name to avoid cache corruption
        name: fresh-builder-${{ github.run_number }}
        driver: docker-container
        # Clean up builder after job to prevent state persistence issues
        cleanup: true

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push multi-arch image (Original Dockerfile + Research Solution)
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}
          ${{ env.REGISTRY_IMAGE }}:latest
        build-args: |
          VERSION=${{ steps.image_tag.outputs.IMAGE_TAG }}
          GIT_REVISION=${{ github.sha }}
        # Research-backed solution: Use GitHub Actions cache backend instead of registry
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # Ensure fresh base images
        pull: true

    - name: Install cosign
      uses: sigstore/cosign-installer@v3.9.2

    - name: Sign the container image
      run: cosign sign --yes ${{ env.REGISTRY_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'

    - name: Fetch kubeconfig
      run: |
        gcloud container clusters get-credentials "$GKE_CLUSTER" \
          --region "$GKE_REGION" \
          --project "$GCP_PROJECT"
        kubectl config current-context
      env:
        GKE_CLUSTER: ${{ vars.GKE_CLUSTER }}
        GKE_REGION: ${{ vars.GKE_REGION }}
        GCP_PROJECT: ${{ vars.GCP_PROJECT }}

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Install Gateway API CRDs
      run: |
        echo "ðŸ“¦ Installing Gateway API CRDs..."
        kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/standard-install.yaml

    - name: Clean up existing Helm releases
      run: |
        echo "ðŸ§¹ Cleaning up existing Helm releases..."
        
        # Create namespace if it doesn't exist
        kubectl create namespace agentgateway-system --dry-run=client -o yaml | kubectl apply -f -
        
        # List current Helm releases
        echo "Current Helm releases in agentgateway-system:"
        helm list -n agentgateway-system || true
        
        # Uninstall any existing releases that might conflict
        echo "Uninstalling existing kgateway release..."
        helm uninstall kgateway -n agentgateway-system --wait 2>/dev/null || echo "No kgateway release found"
        
        echo "Uninstalling existing agentgateway release..."
        helm uninstall agentgateway -n agentgateway-system --wait 2>/dev/null || echo "No agentgateway release found"
        
        # Wait for resources to be deleted
        echo "Waiting for resources to be cleaned up..."
        sleep 10
        
        # Force delete any orphaned resources that might cause conflicts
        echo "Cleaning up any orphaned resources..."
        kubectl delete serviceaccount agentgateway -n agentgateway-system --ignore-not-found=true
        kubectl delete service agentgateway -n agentgateway-system --ignore-not-found=true
        kubectl delete deployment agentgateway -n agentgateway-system --ignore-not-found=true
        kubectl delete serviceaccount,service,deployment -l app.kubernetes.io/name=kgateway -n agentgateway-system --ignore-not-found=true
        
        # Wait a bit more for cleanup
        sleep 5
        
        echo "âœ… Cleanup complete"

    - name: Install kgateway control plane
      run: |
        echo "ðŸŽ›ï¸  Installing kgateway control plane..."
        
        # Install kgateway CRDs (keep release name as agentgateway-crds for compatibility)
        echo "Installing kgateway CRDs..."
        helm upgrade -i agentgateway-crds oci://ghcr.io/kgateway-dev/charts/agentgateway-crds \
          --namespace agentgateway-system \
          --version v2.2.0-main \
          --wait
        
        # Install kgateway control plane with REQUIRED agentgateway.enabled=true
        # Using 'kgateway' as release name per official documentation
        echo "Installing kgateway control plane..."
        helm upgrade -i kgateway oci://ghcr.io/kgateway-dev/charts/agentgateway \
          --namespace agentgateway-system \
          --version v2.2.0-main \
          --values k8s/kgateway-values.yaml \
          --set agentgateway.enabled=true \
          --set controller.image.pullPolicy=Always \
          --wait
        
        echo "âœ… kgateway control plane installed"
        
        # Verify the agentgateway GatewayClass was created
        echo "Verifying agentgateway GatewayClass..."
        kubectl get gatewayclass agentgateway || echo "Warning: GatewayClass not found yet"

    - name: Deploy AgentGateway configuration
      run: |
        echo "ðŸš€ Deploying AgentGateway configuration..."
        
        # Apply SSL cluster issuer
        echo "ðŸ” Setting up SSL cluster issuer..."
        kubectl apply -f k8s/cluster-issuer.yaml
        
        # Apply AgentgatewayParameters
        echo "âš™ï¸  Applying AgentgatewayParameters..."
        kubectl apply -f k8s/agentgateway-params.yaml
        
        # Apply Gateway resource
        echo "ðŸŒ Creating Gateway..."
        kubectl apply -f k8s/gateway.yaml
        
        # NOTE: HTTPRoute is NOT applied when using rawConfig with internal binds
        # The rawConfig in AgentgatewayParameters already defines routes for /health and /
        # See: https://kgateway.dev/docs/main/agentgateway/configuration/#rawconfig
        # The HTTPRoute file (k8s/httproute.yaml) is kept for reference but not used
        
        # Apply UI service and ingress
        echo "ðŸ–¥ï¸  Setting up UI service and ingress..."
        kubectl apply -f k8s/ui-service.yaml
        kubectl apply -f k8s/ui-ingress.yaml
        
        echo "âœ… All resources applied successfully!"

    - name: Wait for Gateway to be ready
      run: |
        echo "â³ Waiting for Gateway to be ready..."
        kubectl wait --for=condition=Programmed gateway/agentgateway -n agentgateway-system --timeout=300s || true
        kubectl get gateway -n agentgateway-system

    - name: Wait for proxy deployment
      run: |
        echo "â³ Waiting for agentgateway proxy to be ready..."
        
        # Wait for deployment to be created (may take a moment after Gateway is created)
        echo "Waiting for deployment to be created..."
        for i in {1..60}; do
          if kubectl get deployment -l gateway.networking.k8s.io/gateway-name=agentgateway -n agentgateway-system 2>/dev/null | grep -q agentgateway; then
            echo "âœ… Deployment found"
            break
          fi
          echo "Waiting for deployment... ($i/60)"
          sleep 5
        done
        
        # Wait for the kgateway-managed proxy deployment to be available
        echo "Waiting for deployment to be available..."
        kubectl wait --for=condition=available deployment -l gateway.networking.k8s.io/gateway-name=agentgateway -n agentgateway-system --timeout=300s || {
          echo "âš ï¸  Deployment did not become available in time"
          kubectl get deployment -l gateway.networking.k8s.io/gateway-name=agentgateway -n agentgateway-system
          kubectl describe deployment -l gateway.networking.k8s.io/gateway-name=agentgateway -n agentgateway-system
        }

    - name: Verify deployment
      run: |
        echo "ðŸ” Checking deployment status..."
        
        echo "ðŸ“Š Gateway status:"
        kubectl get gateway -n agentgateway-system
        
        echo "ðŸš¦ HTTPRoute status (may be empty when using rawConfig):"
        kubectl get httproute -n agentgateway-system || echo "No HTTPRoutes (using rawConfig internal routes)"
        
        echo "ðŸ”Œ Proxy pods:"
        kubectl get pods -n agentgateway-system -l gateway.networking.k8s.io/gateway-name=agentgateway
        
        echo "ðŸŒ Services:"
        kubectl get svc -n agentgateway-system
        
        echo "ðŸ”— Ingresses:"
        kubectl get ingress -n agentgateway-system
        
        echo "ðŸ”’ Certificates:"
        kubectl get certificate -n agentgateway-system || echo "Certificates may still be provisioning"

    - name: Health check
      run: |
        echo "ðŸ©º Performing health checks..."
        
        # Show all pods and services for debugging
        echo "All pods in namespace:"
        kubectl get pods -n agentgateway-system
        
        echo "All services in namespace:"
        kubectl get svc -n agentgateway-system

        # Get the proxy pod name with error handling
        # Try multiple label selectors since kgateway might use different labels
        POD_NAME=$(kubectl get pods -n agentgateway-system -l gateway.networking.k8s.io/gateway-name=agentgateway -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        
        if [ -z "$POD_NAME" ]; then
          echo "Trying alternative label selector..."
          POD_NAME=$(kubectl get pods -n agentgateway-system -l app.kubernetes.io/name=agentgateway -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        fi
        
        if [ -z "$POD_NAME" ]; then
          echo "âŒ No proxy pods found. Checking deployment status..."
          kubectl get deployment -n agentgateway-system
          kubectl get pods -n agentgateway-system -o wide
          kubectl describe gateway agentgateway -n agentgateway-system
          echo "âš ï¸  Continuing with partial health checks..."
        else
          echo "Proxy Pod: $POD_NAME"
        fi

        # Test readiness endpoint via port-forward to pod (only if pod found)
        if [ -n "$POD_NAME" ]; then
          echo "Testing readiness endpoint via port-forward..."
          kubectl port-forward pod/$POD_NAME 15021:15021 -n agentgateway-system &
          PORT_FORWARD_PID=$!
          sleep 3

          if curl -f http://localhost:15021/healthz/ready; then
            echo "âœ… Readiness check passed"
          else
            echo "âŒ Readiness check failed"
          fi

          kill $PORT_FORWARD_PID || true
          sleep 2
        else
          echo "âš ï¸  Skipping pod readiness check (no pod found)"
        fi

        # Test main service /health endpoint
        echo "Testing main service /health endpoint..."
        kubectl port-forward svc/agentgateway 8080:3000 -n agentgateway-system &
        PORT_FORWARD_PID=$!
        sleep 3

        if curl -f http://localhost:8080/health; then
          echo "âœ… Service health check passed"
        else
          echo "âš ï¸  Service health check failed"
        fi

        kill $PORT_FORWARD_PID || true
        sleep 2

        # Test UI endpoint via port-forward
        echo "Testing UI endpoint via port-forward..."
        kubectl port-forward svc/agentgateway-ui 15000:15000 -n agentgateway-system &
        PORT_FORWARD_PID=$!
        sleep 3

        if curl -f http://localhost:15000/ui 2>&1 | grep -q "html\|<!DOCTYPE\|<html"; then
          echo "âœ… UI health check passed"
        else
          echo "âš ï¸  UI health check failed (UI may not be fully initialized)"
        fi

        kill $PORT_FORWARD_PID || true
        sleep 2

        # Test external API endpoint (may fail initially while cert is provisioning)
        echo "Testing external API endpoint..."
        if curl -f -k https://agentgateway.prometheusags.ai/health; then
          echo "âœ… External API health check passed"
        else
          echo "âš ï¸  External API health check failed (may be expected during initial setup)"
        fi

        # Test external UI endpoint (may fail initially while cert is provisioning)
        echo "Testing external UI endpoint..."
        if curl -f -k https://gateway-ui.prometheusags.ai/ui 2>&1 | grep -q "html\|<!DOCTYPE\|<html"; then
          echo "âœ… External UI health check passed"
        else
          echo "âš ï¸  External UI health check failed (may be expected during initial setup)"
        fi

    - name: Deployment summary
      run: |
        echo "ðŸŽ‰ Deployment Summary"
        echo "==================="
        echo "âœ… Built from source: ${{ github.sha }}"
        echo "ðŸ³ Docker image: ${{ env.REGISTRY_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}"
        echo "ðŸŒ API URL: https://agentgateway.prometheusags.ai"
        echo "ðŸ–¥ï¸  UI URL: https://gateway-ui.prometheusags.ai/ui"
        echo "ðŸ”§ Namespace: agentgateway-system"
        echo ""
        echo "ðŸ“‹ Useful commands:"
        echo "  View proxy logs: kubectl logs -f -l gateway.networking.k8s.io/gateway-name=agentgateway -n agentgateway-system"
        echo "  Check Gateway: kubectl describe gateway agentgateway -n agentgateway-system"
        echo "  Check AgentgatewayParameters: kubectl describe agentgatewayparameters agentgateway-config -n agentgateway-system"
        echo "  Check pods: kubectl get pods -n agentgateway-system"
        echo "  Check ingresses: kubectl get ingress -n agentgateway-system"
        echo "  Check certificates: kubectl describe certificate -n agentgateway-system"
        echo ""
        echo "ðŸ”‘ Access UI locally:"
        echo "  kubectl port-forward svc/agentgateway-ui 15000:15000 -n agentgateway-system"
        echo "  Then open: http://localhost:15000/ui"
