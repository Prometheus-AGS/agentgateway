name: Build and Deploy AgentGateway to GKE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_IMAGE: docker.io/tribehealth/agentgateway

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate image tag
      id: image_tag
      run: |
        # Generate timestamp in MMDDYY-HHMM format (UTC)
        IMAGE_TAG=$(date -u +'%m%d%y-%H%M')
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "Generated image tag: ${IMAGE_TAG}"

    - name: Prep Runner
      uses: ./.github/actions/prep-runner

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '23'
        cache: 'npm'
        cache-dependency-path: ui/package-lock.json

    - name: Build UI
      run: |
        cd ui
        npm install
        npm run build

    - name: Set up Docker Buildx (Research-Based Solution)
      uses: docker/setup-buildx-action@v3
      with:
        # Create fresh builder with unique name to avoid cache corruption
        name: fresh-builder-${{ github.run_number }}
        driver: docker-container
        # Clean up builder after job to prevent state persistence issues
        cleanup: true

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push multi-arch image (Original Dockerfile + Research Solution)
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}
          ${{ env.REGISTRY_IMAGE }}:latest
        build-args: |
          VERSION=${{ steps.image_tag.outputs.IMAGE_TAG }}
          GIT_REVISION=${{ github.sha }}
        # Research-backed solution: Use GitHub Actions cache backend instead of registry
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # Ensure fresh base images
        pull: true

    - name: Install cosign
      uses: sigstore/cosign-installer@v3.9.2

    - name: Sign the container image
      run: cosign sign --yes ${{ env.REGISTRY_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'

    - name: Fetch kubeconfig
      run: |
        gcloud container clusters get-credentials "$GKE_CLUSTER" \
          --region "$GKE_REGION" \
          --project "$GCP_PROJECT"
        kubectl config current-context
      env:
        GKE_CLUSTER: ${{ vars.GKE_CLUSTER }}
        GKE_REGION: ${{ vars.GKE_REGION }}
        GCP_PROJECT: ${{ vars.GCP_PROJECT }}

    - name: Deploy to Kubernetes
      run: |
        echo "üöÄ Deploying AgentGateway to Kubernetes..."
        echo "üìå Using image tag: ${{ steps.image_tag.outputs.IMAGE_TAG }}"

        # Replace placeholder with actual image tag in deployment manifest
        sed -i 's|IMAGE_TAG_PLACEHOLDER|${{ steps.image_tag.outputs.IMAGE_TAG }}|g' k8s/deployment.yaml

        # Apply all Kubernetes resources
        echo "üì¶ Creating namespace..."
        kubectl apply -f k8s/namespace.yaml

        echo "‚öôÔ∏è  Applying configuration..."
        kubectl apply -f k8s/configmap.yaml

        echo "üöÄ Deploying application..."
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml

        echo "üîê Setting up SSL and ingress..."
        kubectl apply -f k8s/cluster-issuer.yaml
        kubectl apply -f k8s/ingress.yaml

        echo "‚úÖ All resources applied successfully!"

    - name: Wait for deployment
      run: |
        echo "‚è≥ Waiting for deployment to be ready..."
        kubectl rollout status deployment/agentgateway -n agentgateway --timeout=300s

    - name: Verify deployment
      run: |
        echo "üîç Checking deployment status..."
        kubectl get pods -n agentgateway -l app=agentgateway

        echo "üåê Checking service status..."
        kubectl get svc -n agentgateway

        echo "üîó Checking ingress status..."
        kubectl get ingress -n agentgateway

        echo "üîí Checking certificate status..."
        kubectl get certificate -n agentgateway || echo "Certificate may still be provisioning"

    - name: Health check
      run: |
        echo "ü©∫ Performing health checks..."

        # Get the pod name
        POD_NAME=$(kubectl get pods -n agentgateway -l app=agentgateway -o jsonpath='{.items[0].metadata.name}')
        echo "Pod: $POD_NAME"

        # Test readiness endpoint via port-forward to pod
        echo "Testing readiness endpoint via port-forward..."
        kubectl port-forward pod/$POD_NAME 15021:15021 -n agentgateway &
        PORT_FORWARD_PID=$!
        sleep 3

        if curl -f http://localhost:15021/healthz/ready; then
          echo "‚úÖ Readiness check passed"
        else
          echo "‚ùå Readiness check failed"
        fi

        kill $PORT_FORWARD_PID || true
        sleep 2

        # Test main service /health endpoint
        echo "Testing main service /health endpoint..."
        kubectl port-forward svc/agentgateway-service 8080:80 -n agentgateway &
        PORT_FORWARD_PID=$!
        sleep 3

        if curl -f http://localhost:8080/health; then
          echo "‚úÖ Service health check passed"
        else
          echo "‚ö†Ô∏è  Service health check failed (directResponse route may not be configured)"
        fi

        kill $PORT_FORWARD_PID || true
        sleep 2

        # Test external endpoint (may fail initially while cert is provisioning)
        echo "Testing external endpoint..."
        if curl -f -k https://agentgateway.prometheusags.ai/health; then
          echo "‚úÖ External health check passed"
        else
          echo "‚ö†Ô∏è  External health check failed (may be expected during initial setup)"
        fi

    - name: Deployment summary
      run: |
        echo "üéâ Deployment Summary"
        echo "==================="
        echo "‚úÖ Built from source: ${{ github.sha }}"
        echo "üê≥ Docker image: ${{ env.REGISTRY_IMAGE }}:${{ steps.image_tag.outputs.IMAGE_TAG }}"
        echo "üåç Service URL: https://agentgateway.prometheusags.ai"
        echo "üîß Namespace: agentgateway"
        echo ""
        echo "üìã Useful commands:"
        echo "  View logs: kubectl logs -f deployment/agentgateway -n agentgateway"
        echo "  Check pods: kubectl get pods -n agentgateway"
        echo "  Check ingress: kubectl describe ingress agentgateway-ingress -n agentgateway"
        echo "  Check cert: kubectl describe certificate agentgateway-tls -n agentgateway"
